---
import MainLayout from "../../layouts/mainlayout.astro";
import Sidebar from "../../components/sidebar.astro";
import MainContent from "../../components/maincontent.astro";

import path from "path";
import { dirname, resolve } from "path";
import { fileURLToPath } from "url";
import fs from "fs";
import fsp from "fs/promises";

// Fonction pour récupérer les niveaux
export async function getStaticPaths() {
    const __filename = fileURLToPath(import.meta.url);
    const __dirname = path.dirname(__filename);
    let currentDir = __dirname;
    // Boucle pour trouver le répertoire racine du projet
    while (currentDir !== resolve(currentDir, "..")) {
        // Arrêter à la racine du système
        if (fs.existsSync(resolve(currentDir, "package.json"))) {
            break;
        }
        currentDir = resolve(currentDir, "..");
    }
    const projectRoot = currentDir;

    const levelsPath = resolve(projectRoot, "ressources");

    const levels = await fsp
        .readdir(levelsPath, { withFileTypes: true })
        .then((files) =>
            files.filter((f) => f.isDirectory()).map((f) => f.name),
        )
        .catch(() => []);

    const paths = [];

    for (const level of levels) {
        paths.push({
            params: { level: level },
            props: { currentLevel: level },
        });
    }
    return paths;
}

const { currentLevel } = Astro.props;
---

<MainLayout>
    <Sidebar slot="sidebar" currentLevel={currentLevel} />
    <MainContent slot="maincontent" />
</MainLayout>
